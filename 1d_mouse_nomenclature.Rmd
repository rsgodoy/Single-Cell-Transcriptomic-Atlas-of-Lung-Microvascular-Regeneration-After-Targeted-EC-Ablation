---
title: "1d_mouse_nomenclature"
output: html_notebook
---

#1_Libraries

```{r}
getRversion()
```

```{r}
getwd()
```
```{r}
library(Seurat)
library(dplyr)
library(tidyr)
library(ggplot2)
library(Rtsne)
library(cowplot)
library(enrichCellMarkers)
#library(packrat)
library(cowplot)
library(glue)
library(knitr)
library(tidyverse)
library(ggraph)
library(clustree)
#library(tidytree)
#library(treeio)
#library(ggtree)
```

#2_RDS

```{r}
seurat <- readRDS("./0_raw_data_David_new_data_Nov_2020/seurat_filtered_processed.rds")
```

```{r}
seurat
```

##Add Totalcells column and fix labels

```{r}
seurat$Totalcells <- seurat$orig.ident
seurat$Totalcells[seurat$orig.ident %in% c("PoolA", "PoolB", "PoolC")] <- "Cells"
```

```{r}
seurat$Sample[seurat$Sample %in% c("DTP_7d")] <- "DPT_7d"
```

```{r}
table(seurat@meta.data$Sample)
```

##Assay

```{r}
DefaultAssay(seurat) <- "RNA" # We use the RNA for all quantitative downstream analyses
```

#3_UMAPs

```{r}
Fig <- DimPlot(seurat, cols = c('#E75B64','#278B9A', '#5A6F80', '#E8C4A2', 
                           '#DE7862', '#D8AF39', '#4C413F', '#5C5992',
                           '#403369', '#AE93BE','#B4DAE5' , '#F0D77B', 
                           '#2C715F', '#44A57C', '#819A7A', '#58A449', 
                           '#CEC917','#B50A2A', '#9E8356', '#7EBAC2',
                           '#D1B79E'),
        label = T, pt.size = 1.5) + NoAxes()

#ggsave(Fig, filename="/Users/rafaelgodoy/Desktop/1d_UMAPglobal_labelBIG_noaxis_nolabel.png", width=12, height=7, dpi=900)
Fig
```

##3b_UMAP per condition

Control alone 

```{r}
scramble <- sample(ncol(seurat), replace=FALSE)

data <- seurat@meta.data
data$UMAP1 = Embeddings(seurat, reduction="umap")[,1]
data$UMAP2 = Embeddings(seurat, reduction="umap")[,2]

data <- data[scramble,]
 
data$Sample <- factor(data$Sample, levels=c("Ctrl"))

data_bg <- data
data_bg$Totalcells <- NULL

data_plot <- ggplot(data, aes(x=UMAP1, y=UMAP2)) +
  geom_point(data=data_bg, size=2, alpha=0.75, color='lightgrey') +
  geom_point(size=2, alpha=0.2, aes(color=Sample)) +
   scale_color_manual(values=c('#0E84B4')) +
  facet_wrap(~Totalcells, ncol = 4) +
  theme_void() +
  theme(legend.position="none")
        ggsave(data_plot, filename="/Users/rafaelgodoy/Desktop/testUMAPglobal2.png", width=12, height=7, dpi=900)

data_plot
```

```{r}
scramble <- sample(ncol(seurat), replace=FALSE)

data <- seurat@meta.data
data$UMAP1 = Embeddings(seurat, reduction="umap")[,1]
data$UMAP2 = Embeddings(seurat, reduction="umap")[,2]

data <- data[scramble,]
 
data$Sample <- factor(data$Sample, levels=c("DPT_3d","DPT_5d","DPT_7d"))

data_bg <- data
data_bg$Totalcells <- NULL

data_plot <- ggplot(data, aes(x=UMAP1, y=UMAP2)) +
  geom_point(data=data_bg, size=2, alpha=0.75, color='lightgrey') +
  geom_point(size=2, alpha=0.2, aes(color=Sample)) +
   scale_color_manual(values=c('#44A57C', '#E75B64', '#AE93BE')) +
  facet_wrap(~Totalcells, ncol = 4) +
  theme_void() +
  theme(legend.position="none")
        ggsave(data_plot, filename="/Users/rafaelgodoy/Desktop/testUMAPglobal3.png", width=12, height=7, dpi=900)

data_plot
```

```{r}
scramble <- sample(ncol(seurat), replace=FALSE)

data <- seurat@meta.data
data$UMAP1 = Embeddings(seurat, reduction="umap")[,1]
data$UMAP2 = Embeddings(seurat, reduction="umap")[,2]

data <- data[scramble,]
 
data$Sample <- factor(data$Sample, levels=c("DPT_3d"))

data_bg <- data
data_bg$Totalcells <- NULL

data_plot <- ggplot(data, aes(x=UMAP1, y=UMAP2)) +
  geom_point(data=data_bg, size=2, alpha=0.75, color='lightgrey') +
  geom_point(size=2, alpha=0.2, aes(color=Sample)) +
   scale_color_manual(values=c('#44A57C')) +
  facet_wrap(~Totalcells, ncol = 4) +
  theme_void() +
  theme(legend.position="none")
        ggsave(data_plot, filename="/Users/rafaelgodoy/Desktop/testUMAPglobal4.png", width=12, height=7, dpi=900)

data_plot
```

```{r}
scramble <- sample(ncol(seurat), replace=FALSE)

data <- seurat@meta.data
data$UMAP1 = Embeddings(seurat, reduction="umap")[,1]
data$UMAP2 = Embeddings(seurat, reduction="umap")[,2]

data <- data[scramble,]
 
data$Sample <- factor(data$Sample, levels=c("DPT_5d"))

data_bg <- data
data_bg$Totalcells <- NULL

data_plot <- ggplot(data, aes(x=UMAP1, y=UMAP2)) +
  geom_point(data=data_bg, size=2, alpha=0.75, color='lightgrey') +
  geom_point(size=2, alpha=0.2, aes(color=Sample)) +
   scale_color_manual(values=c('#E75B64')) +
  facet_wrap(~Totalcells, ncol = 4) +
  theme_void() +
  theme(legend.position="none")
        ggsave(data_plot, filename="/Users/rafaelgodoy/Desktop/testUMAPglobal5.png", width=12, height=7, dpi=900)

data_plot
```

```{r}
scramble <- sample(ncol(seurat), replace=FALSE)

data <- seurat@meta.data
data$UMAP1 = Embeddings(seurat, reduction="umap")[,1]
data$UMAP2 = Embeddings(seurat, reduction="umap")[,2]

data <- data[scramble,]
 
data$Sample <- factor(data$Sample, levels=c("DPT_7d"))

data_bg <- data
data_bg$Totalcells <- NULL

data_plot <- ggplot(data, aes(x=UMAP1, y=UMAP2)) +
  geom_point(data=data_bg, size=2, alpha=0.75, color='lightgrey') +
  geom_point(size=2, alpha=0.2, aes(color=Sample)) +
   scale_color_manual(values=c('#AE93BE')) +
  facet_wrap(~Totalcells, ncol = 4) +
  theme_void() +
  theme(legend.position="none")
        ggsave(data_plot, filename="/Users/rafaelgodoy/Desktop/testUMAPglobal6.png", width=12, height=7, dpi=900)

data_plot
```






#4_LABEL CELLS

##Majorgrouping

  Cldn5 = endothelial
  Epcam = epithelial 
  Col1a2 = stromal
  Ptprc = immune cell
  

```{r}
Fig <- FeaturePlot(seurat,features = c("Cldn5"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = F, order = F, pt.size = 2) + NoAxes() 
ggsave(Fig, filename="/Users/rafaelgodoy/Desktop/1d_CLDN5.png", width=12, height=7, dpi=900)
Fig
```

```{r}
Fig <- FeaturePlot(seurat,features = c("Epcam"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = F, order = T, pt.size = 2) + NoAxes()
#ggsave(Fig, filename="/Users/rafaelgodoy/Desktop/1d_EPCAM.png", width=12, height=7, dpi=900)
Fig
```

```{r}
Fig <- FeaturePlot(seurat,features = c("Col1a2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = F, order = F, pt.size = 2) + NoAxes()
ggsave(Fig, filename="/Users/rafaelgodoy/Desktop/1d_COL1a2.png", width=12, height=7, dpi=900)
Fig
```

```{r}
Fig <- FeaturePlot(seurat,features = c("Ptprc"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = F, order = F, pt.size = 2) + NoAxes()
ggsave(Fig, filename="/Users/rafaelgodoy/Desktop/1d_PTPRC.png", width=12, height=7, dpi=900)
Fig
```

#5_ECs

```{r}
FeaturePlot(seurat,features = c("Cldn5"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r}
FeaturePlot(seurat,features = c("Kdr"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```
```{r}
FeaturePlot(seurat,features = c("Vwf"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r}
FeaturePlot(seurat,features = c("Cdh5"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

##Artery

```{r}
FeaturePlot(seurat,features = c("Nrp1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r}
FeaturePlot(seurat,features = c("Ephb2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
#Connexin40
FeaturePlot(seurat,features = c("Gja5"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Notch1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

####Artery based on Travaglini et al 2019

```{r} 
FeaturePlot(seurat,features = c("Bmx"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = T)
```

```{r} 
FeaturePlot(seurat,features = c("Dkk2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = T)
```

###Vein

```{r} 
FeaturePlot(seurat,features = c("Ephb4"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
#also known as COUP-TFII
FeaturePlot(seurat,features = c("Nr2f2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

####Vein according to Travaglini et al 2019

```{r} 
FeaturePlot(seurat,features = c("Slc6a2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Amigo2"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```
```{r} 
FeaturePlot(seurat,features = c("Vegfc"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

###Capilary a -- according to Travaglini et al 2019

```{r} 
FeaturePlot(seurat,features = c("Car4"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Ednrb"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Prx"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

###Capilary2 according to Travaglini et al 2019

```{r} 
FeaturePlot(seurat,features = c("Plvap"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Gpihbp1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Cd93"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

##Lymphatic

```{r} 
FeaturePlot(seurat,features = c("Prox1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Pdpn"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

```{r} 
FeaturePlot(seurat,features = c("Mmrn1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

###EC injury markers
```{r} 
FeaturePlot(seurat,features = c("Icam1"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```
```{r} 
FeaturePlot(seurat,features = c("Vwf"), reduction = "umap", col = c("lightgrey","#B50A2A"), label = T, order = F)
```

#6_One cluster at a time 

##Find Variable genes

```{r}
markers <- FindAllMarkers(seurat, only.pos=T, logfc.threshold = 1)
```

Defines an object called reduce_markers which contains only the top 20 genes for each cluster based on their avg_logFC

```{r}
reduce_markers <- markers %>% group_by(cluster) %>% top_n(n = 20, wt = avg_logFC)
```

```{r}
top5 <- markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
```

When I have Java installed properly this should work to create an excel file with the data
```{r}
#library(xlsx)
#write.xlsx(reduce_markers, file = "Top5_byCluster")
```

Until I have excel export working I will export it into a tab delimited text file
```{r}
#write.table(reduce_markers, file = "/Users/rafaelgodoy/Documents/CODE/6b_mouse_DTR_opt/RafDATA/tables/2Top20_byCluster_seurat2a_mouse_opt")
```

```{r}
top5
```

###Cluster10

```{r}
reduced_markers=CMenrich(gene.list=c('Sftpc','Sftpa1','Sftpb','Cxcl15',
                                     'Slc34a2'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```


###Cluster12

```{r}
reduced_markers=CMenrich(gene.list=c('Cd17','H2-Eb1','H2-Aa','Cst3',
                                     'H2-Ab1'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```

###Cluster13

```{r}
reduced_markers=CMenrich(gene.list=c('Cbr2','Wfdc2','Scgb3a2','Scgb1a1',
                                     'Scgb3a1'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```

###Cluster14

```{r}
reduced_markers=CMenrich(gene.list=c('Cxcl9','Cxcl10','Gadd45b','Ifrd1',
                                     'Egr1'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```

###Cluster17

```{r}
reduced_markers=CMenrich(gene.list=c('Ager','Igfbp2','Cldn18','Aqp5',
                                     'Hopx'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```

###Cluster18

```{r}
reduced_markers=CMenrich(gene.list=c('Hba-a1','Hba-a2','Hbb-bt','Alas2',
                                     'Hbb-bs'), 
                         species='mouse')
DT::datatable(reduced_markers$enrichments)
```

#AUGUR AI score 

**This package had some issues running on R3.6, therefore run it with Docker file for Muscat, but must install pre-req packages again everytime runing these commands plus cowplot.

```{r}
devtools::install_github("const-ae/sparseMatrixStats")
devtools::install_github("Bioconductor/MatrixGenerics")
devtools::install_github("neurorestore/Augur")
install.packages("generics")
```


```{r}
library(Augur)
```

```{r}
#options(stringsAsFactors = F)
library(tidyverse)
library(magrittr)
library(broom)
library(Seurat)
#library(clustree)
library(ggplot2)
#library(paletteer)
library(reprex)
library(cowplot)
```


```{r}
DefaultAssay(object = seurat)
```

##Augur_Assay "RNA"

```{r}
DefaultAssay(seurat) <- "RNA" #can switch back to integrated if desired
```

```{r}
DefaultAssay(seurat)
```

```{r}
#seurat.sce <- as.SingleCellExperiment(seurat)
```

```{r}
augur = calculate_auc(seurat, cell_type_col = "seurat_clusters", label_col = "Sample")
```


```{r}
head(augur, n = 10)
```

```{r}
#saveRDS(augur, file = "./augur_processed.rds")
```

```{r}
pB <- augur
```

```{r}
sapply(pB, class)
```

```{r}
#pB <- unlist(augur, recursive = TRUE, use.names = TRUE)
```

```{r}
class(pB)
```

```{r}
#pB <- as.vector(unlist(pB))
```

```{r}
pB <- bind_rows(data.frame(pB$AUC))
```

```{r}
class(pB)
```


```{r}
pC <- pB %>%
  ggplot(aes(x = reorder(cell_type, -auc), y = auc)) + 
  geom_hline(aes(yintercept = 0.5), linetype = 'dotted') +
  geom_point(size = 2) +
  geom_text(aes(label = format(auc, digits = 3)), size = 2,
            nudge_y = 0.025, angle = 45, hjust = 0) +
  geom_segment(aes(xend = cell_type, yend = 0.5)) + 
  scale_y_continuous('AUC', limits = c(0.5, 0.7)) +
  theme_cowplot()
  
pC
ggsave("./1_augurAUC.pdf", pC, width = 11.5, height = 4.5, 
       units = "cm", useDingbats = F)

```

```{r}
pD <- pB %>%
  ggplot(aes(x = reorder(cell_type, -auc), y = auc)) + 
  geom_hline(aes(yintercept = 0.5), linetype = 'dotted') +
  geom_point(size = 2) +
  geom_text(aes(label = format(auc, digits = 3)), size = 2,
            nudge_y = 0.025, angle = 45, hjust = 0) +
  geom_segment(aes(xend = cell_type, yend = 0.5)) + 
  scale_y_continuous('AUC', limits = c(0.5, 0.75)) +
  theme_cowplot()
pD
#ggsave("/Users/rafaelgodoy/Documents/CODE/6b_mouse_DTR_opt/5b_6b_mouseDTRopt_AUGUR/1b_augurAUC.pdf", pD, width = 11.5, height = 4.5, 
#       units = "cm", useDingbats = F)

```





